generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProgramFrequency {
  daily
  weekly
  monthly
  adhoc
}

enum ProgramMode {
  single
  flow
}

enum ProgramCategory {
  mind
  body
  human
  environment
  business
}

enum ExerciseType {
  checkbox
  scale
  multiselect
  text
  number
  html
}

enum XpTransactionType {
  earn
  spend
}

enum JournalType {
  learn
  success
  gratitude
}

enum RewardStatus {
  pending
  approved
  rejected
  cancelled
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  runs        ProgramRun[]
  xp          XpTransaction[]
  rewards     RewardRedemption[]
  journals    Journal[]
  journalLogs JournalEntry[]
  goalCheckins MindGoalCheckin[]
  brainSessions BrainExerciseSession[]
  milestoneProgress LearningMilestoneProgress[]
  emotionLogs EmotionLog[]
}

model Program {
  id              String            @id @default(cuid())
  slug            String            @unique
  code            String
  name            String
  summary         String
  category        ProgramCategory
  frequency       ProgramFrequency
  durationMinutes Int
  xpReward        Int
  mode            ProgramMode
  createdAt       DateTime          @default(now())

  units ProgramUnit[]
  runs  ProgramRun[]
}

model ProgramUnit {
  id        String     @id @default(cuid())
  programId String
  title     String
  order     Int

  program   Program    @relation(fields: [programId], references: [id])
  exercises Exercise[]
}

model Exercise {
  id        String       @id @default(cuid())
  unitId    String
  label     String
  description String?
  type      ExerciseType
  config    Json?
  xpValue   Int @default(0)

  unit ProgramUnit @relation(fields: [unitId], references: [id])
}

model ProgramRun {
  id        String       @id @default(cuid())
  programId String
  userId    String
  mode      ProgramMode
  xpEarned  Int
  answers   Json
  createdAt DateTime      @default(now())

  program Program @relation(fields: [programId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
  xp      XpTransaction[]
}

model ProgramStack {
  id           String   @id @default(cuid())
  slug         String   @unique
  title        String
  summary      String
  programSlugs String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model XpTransaction {
  id                String            @id @default(cuid())
  userId            String
  category          ProgramCategory
  amount            Int
  type              XpTransactionType
  source            String
  programRunId      String?
  rewardRedemptionId String?
  createdAt         DateTime          @default(now())

  user      User           @relation(fields: [userId], references: [id])
  programRun ProgramRun?   @relation(fields: [programRunId], references: [id])
  reward    RewardRedemption? @relation(fields: [rewardRedemptionId], references: [id])
}

model Reward {
  id          String   @id @default(cuid())
  name        String
  description String
  cost        Int
  active      Boolean  @default(true)

  redemptions RewardRedemption[]
}

model RewardRedemption {
  id        String       @id @default(cuid())
  rewardId  String
  userId    String
  status    RewardStatus @default(pending)
  requestedAt DateTime   @default(now())
  resolvedAt DateTime?
  notes     String?

  reward Reward @relation(fields: [rewardId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
  xp     XpTransaction[]
}

model Journal {
  id        String      @id @default(cuid())
  userId    String
  name      String
  type      JournalType

  user    User          @relation(fields: [userId], references: [id])
  entries JournalEntry[]
}

model JournalEntry {
  id         String   @id @default(cuid())
  journalId  String
  userId     String?
  contentHtml String
  createdAt  DateTime @default(now())

  journal Journal @relation(fields: [journalId], references: [id])
  user    User?   @relation(fields: [userId], references: [id])
}

model MindVisualizationAsset {
  id        String   @id @default(cuid())
  title     String
  imageData String
  order     Int      @default(0)
  createdAt DateTime @default(now())
}

model MindGoal {
  id           String   @id @default(cuid())
  title        String
  specific     String
  measurable   String
  achievable   String
  relevant     String
  timeBound    String
  metricName   String?
  targetValue  Int?
  unit         String?
  targetDate   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  checkins MindGoalCheckin[]
}

model MindGoalCheckin {
  id              String   @id @default(cuid())
  goalId          String
  userId          String?
  progressPercent Int
  selfAssessment  String?
  readThrough     Boolean  @default(false)
  createdAt       DateTime @default(now())

  goal MindGoal @relation(fields: [goalId], references: [id])
  user User?    @relation(fields: [userId], references: [id])
}

model BrainExercise {
  id              String   @id @default(cuid())
  title           String
  focusArea       String
  description     String
  difficulty      Int
  durationMinutes Int
  rating          Int?
  createdAt       DateTime @default(now())

  sessions BrainExerciseSession[]
}

model BrainExerciseSession {
  id          String   @id @default(cuid())
  exerciseId  String
  userId      String?
  rating      Int?
  notes       String?
  completedAt DateTime @default(now())

  exercise BrainExercise @relation(fields: [exerciseId], references: [id])
  user     User?         @relation(fields: [userId], references: [id])
}

model LearningPath {
  id          String   @id @default(cuid())
  title       String
  theme       String
  description String
  createdAt   DateTime @default(now())

  milestones LearningMilestone[]
}

model LearningMilestone {
  id          String   @id @default(cuid())
  pathId      String
  title       String
  description String
  order       Int

  path     LearningPath @relation(fields: [pathId], references: [id])
  progress LearningMilestoneProgress[]
}

model LearningMilestoneProgress {
  id          String   @id @default(cuid())
  milestoneId String
  userId      String?
  completed   Boolean  @default(false)
  updatedAt   DateTime @updatedAt

  milestone LearningMilestone @relation(fields: [milestoneId], references: [id])
  user      User?             @relation(fields: [userId], references: [id])

  @@unique([milestoneId, userId])
}

model EmotionPractice {
  id              String   @id @default(cuid())
  emotion         String
  summary         String
  regulationSteps Json
  groundingPrompt String?
  createdAt       DateTime @default(now())

  logs EmotionLog[]
}

model EmotionLog {
  id         String   @id @default(cuid())
  userId     String?
  practiceId String?
  emotionLabel String
  intensity  Int
  note       String?
  createdAt  DateTime @default(now())

  practice EmotionPractice? @relation(fields: [practiceId], references: [id])
  user     User?            @relation(fields: [userId], references: [id])
}
